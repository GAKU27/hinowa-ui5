<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>灯輪 Hinowa — v5 Flat</title>
<style>
:root{--bg:#0d1117;--panel:#0f1724;--ink:#e6edf3;--muted:#9fb0d8;--line:#243b68;--accent:#4ea2ff}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic UI","Noto Sans JP",Meiryo,sans-serif}
header{position:sticky;top:0;z-index:10;background:rgba(13,17,23,.85);backdrop-filter:saturate(1.2) blur(6px);border-bottom:1px solid var(--line)}
header .bar{display:flex;gap:12px;align-items:center;padding:10px 14px;flex-wrap:wrap}
.chip{padding:6px 10px;border:1px solid var(--line);border-radius:999px;font-size:13px;color:var(--muted)}
.chip.ok{color:#b4f5c6;border-color:#2a6c45}
main{max-width:1100px;margin:0 auto;padding:14px;display:grid;gap:14px}
.row{display:grid;grid-template-columns:1fr;gap:14px}
@media(min-width:960px){.row{grid-template-columns:1.1fr .9fr}}
.card{background:linear-gradient(180deg,#0f1724,#0a1324);border:1px solid var(--line);border-radius:12px;padding:12px}
.title{font-size:14px;color:var(--muted);margin-bottom:8px}
textarea{width:100%;min-height:180px;background:#0b1428;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:12px;resize:vertical;font-size:15px;line-height:1.6}
.btns{display:flex;flex-wrap:wrap;gap:10px}
button{background:#193766;color:#fff;border:1px solid #2b4f87;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
button:disabled{opacity:.55;cursor:not-allowed}
.btn-secondary{background:#13233f}
pre{white-space:pre-wrap;background:#091124;border:1px solid var(--line);border-radius:10px;padding:10px;margin:0}
.pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);padding:6px 9px;border-radius:999px;margin-left:6px}
.pill.low{color:#a7d0ff;border-color:#2a4881}
.pill.medium{color:#ffe39a;border-color:#7a5e18}
.pill.high{color:#ffd0d0;border-color:#7a2d2d}
.pill.critical{color:#ffc8ff;border-color:#7a2d6b}
.result{display:flex;align-items:center;gap:10px}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;font-size:12px;color:#d0dbff}
.colorbar{display:flex;gap:8px;padding-top:6px}
.colorchip{flex:1;height:18px;border-radius:8px;border:1px solid #223a70}
.footer{color:var(--muted);font-size:12px;text-align:center;padding:16px 0}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="chip">辞書: <b id="dictStatus">loading</b></div>
    <div class="chip">FirePath: <b id="fpStatus">idle</b></div>
    <div class="chip ok">JS: ready</div>
  </div>
</header>
<main>
  <div class="row">
    <div class="card">
      <div class="title">テキスト（空にすると完全リセット）</div>
      <textarea id="txt" placeholder="例：もう無理…でも朝に散歩をして少し落ち着いた。今日は友人に短く連絡して、できることを一つだけやってみる。"></textarea>
      <div class="btns" style="margin-top:10px">
        <button id="calcBtn">計算</button>
        <button id="demoBtn" class="btn-secondary">デモ</button>
        <button id="clearBtn" class="btn-secondary">消去</button>
      </div>
    </div>
    <div class="card">
      <div class="title">結果</div>
      <div class="result">
        <div>FAS: <b id="fasVal">—</b></div><span id="fasBadge" class="pill">idle</span>
      </div>
      <div class="colorbar" id="fpColors" aria-label="firepath colors">
        <div class="colorchip" id="colorPast" title="昔の色"></div>
        <div class="colorchip" id="colorNow" title="今の色"></div>
        <div class="colorchip" id="colorFuture" title="未来の色"></div>
      </div>
      <div class="title" style="margin-top:10px">要約</div>
      <pre id="sumOut" class="mono">(ここに要約が表示されます)</pre>
    </div>
  </div>
  <div class="card">
    <div class="title">JSON（灯輪 v5 deep sea 準拠）</div>
    <pre id="jsonOut" class="mono">{}</pre>
  </div>
  <div class="footer">※ ローカルのみで計算／外部送信なし — © Hinowa v5 Flat</div>
</main>

<!-- inline data blobs -->
<script type="application/json" id="templates">{"low": ["ゆっくりでいいよ。焦らなくて、大丈夫。{{step}}", "ちゃんと届いてるよ。その気持ち、ここに置いておこう。{{step}}", "いまは休む時かも。水を一口、呼吸を3回。一緒に整えよう。{{step}}"], "medium": ["うん、つらいよね。でも、こうして言葉にできてる。えらいよ。{{step}}", "今日できることを一つだけ決めよう。無理なく、小さくでいい。{{step}}", "いったん姿勢を整えて、肩の力を抜こう。ここから少しずつで大丈夫。{{step}}"], "high": ["君の声、ちゃんと聞こえてる。ひとりじゃない。今は安全第一でいこう。{{step}}", "呼吸を合わせよう。四拍吸って、四拍止めて、六拍で吐く。いま一緒に。{{step}}", "強いしんどさだね。近しい人に短く連絡するのも◎。ここにいるよ。{{step}}"], "critical": ["灯が叫んでいる。まず安全を最優先に。必要なら【地域の相談先】も検討しよう。{{step}}", "いまは命が最優先。近くの人に合図できる？一緒に息を合わせよう。{{step}}", "すぐに環境を安全側に。扉を開けて、明かりをつけて、水を一口。ここにいる。{{step}}"]}</script>
<script type="application/json" id="palette">[{"name": "Indigo Calm", "jp": "深い藍", "range": [0.0, 0.3], "hex": "#0d1b2a", "note": "静かな内省"}, {"name": "Blue Hesitation", "jp": "群青", "range": [0.3, 0.5], "hex": "#1b3b73", "note": "迷いと逡巡"}, {"name": "Amber Flicker", "jp": "橙", "range": [0.5, 0.7], "hex": "#de8a2a", "note": "揺らぎと兆し"}, {"name": "Ash Red", "jp": "灰赤", "range": [0.6, 0.8], "hex": "#8a3b3b", "note": "疲労と焦燥"}, {"name": "Crimson Flare", "jp": "真紅", "range": [0.8, 1.0], "hex": "#c1121f", "note": "緊急の叫び"}]</script>
<script type="application/json" id="modecfg">{"thresholds": {"critical": 0.85, "high": 0.68, "medium": 0.5}}</script>

<script>
const $ = id=>document.getElementById(id);
function setStatus(id, text, ok=false){ $(id).textContent=text; const el=$(id).parentElement; el.classList.toggle('ok', ok); }
function labelByFAS(f, thr){ if(f>=thr.critical) return 'critical'; if(f>=thr.high) return 'high'; if(f>=thr.medium) return 'medium'; return 'low'; }
function badge(level){ const b=$('fasBadge'); b.className='pill '+level; b.textContent=level; }
function loadJSON(path, id){ return fetch(path, {cache:'no-store'}).then(r=>{ if(!r.ok) throw new Error(r.status); return r.json(); }).then(j=>{ setStatus(id,'ready',true); return j; }).catch(e=>{ setStatus(id,'error'); console.error('load',path,e); return null; }); }
const TPL = JSON.parse(document.getElementById('templates').textContent);
const PAL = JSON.parse(document.getElementById('palette').textContent);
const MODE = JSON.parse(document.getElementById('modecfg').textContent);
function colorForFAS(f){ for(const p of PAL){ const lo=p.range[0], hi=p.range[1]; if(f>=lo && f<hi) return p; } return PAL[0]; }
const History = { read(){ try{ return JSON.parse(localStorage.getItem('hinowa_hist')||'[]'); }catch(_){ return []; }}, write(a){ localStorage.setItem('hinowa_hist', JSON.stringify(a.slice(-50))); }, push(item){ const a=this.read(); a.push(Object.assign({},{FAS:item.FAS,mode:item.mode,t:Date.now()})); this.write(a); }, clear(){ localStorage.removeItem('hinowa_hist'); } };
let DICT=null;
function summarize(result){
  const thr=MODE.thresholds, lvl=labelByFAS(result.FAS,thr);
  const pool=(TPL && TPL[lvl])||[]; const pick=pool.length? pool[Math.floor(Math.random()*pool.length)] : '[INFO]';
  const steps_low='次の一歩は「深呼吸×3 → 水を一杯 → 姿勢を整える」。';
  const steps_mid='今できる1分行動をひとつ（深呼吸・水・近しい人へ短い連絡）で安全第一に。';
  const steps_hi='強いしんどさ。安全の確保を最優先に、近しい人や地域の相談先も検討しよう。';
  let step=steps_low; if(lvl==='medium') step=steps_mid; if(lvl==='high'||lvl==='critical') step=steps_hi;
  return pick.replace(/\{\{step\}\}/g, step);
}
function compute(text){
  const negTags=['危機','希死','救援','体感','感情/ネガ'];
  const posTags=['感情/ポジ','対処','支援','予定'];
  let neg=0,pos=0;
  const t=text||'';
  const clusters=(DICT&&DICT.clusters)||[];
  for(const c of clusters){
    const isNeg=negTags.includes(c.tag), isPos=posTags.includes(c.tag);
    if(!isNeg && !isPos) continue;
    const entries=c.entries||[]; const weight=+c.weight||0.35;
    for(let i=0; i<entries.length && i<4000; i++){
      const e=entries[i];
      try{ const re=new RegExp(e.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'g'); const m=t.match(re); if(m){ if(isNeg) neg+=m.length*weight; else pos+=m.length*(weight*0.7); } }
      catch(_){}
    }
  }
  if(/(助けて){2,}/.test(t)) neg+=2.5;
  if(/(死にたい|消えたい)/.test(t)) neg+=3.0;
  if(/(深呼吸|散歩|相談|水)/.test(t)) pos+=1.0;
  const fasCore=Math.max(0, Math.min(1, 0.5 + 0.1*neg - 0.07*pos));
  const CUS=Math.max(0, Math.min(1, 0.3 + 0.05*pos));
  const RIS=Math.max(0, Math.min(1, 0.2 + 0.05*pos));
  const EIS=0.6;
  const SSS=Math.max(0, Math.min(1, 0.3 + 0.03*pos - 0.02*neg));
  const FAS=fasCore;
  const mode=FAS>=0.85?'E1': FAS>=0.68?(CUS>=0.66?'P1':(CUS>=0.33?'P2':'EPR')): FAS>=0.50?(CUS>=0.66?'R1':(CUS>=0.33?'S2':'S1')): (CUS>=0.66?'FirePath':(CUS>=0.33?'R3':'ε1'));
  return {FAS, CUS, RIS, EIS, SSS, mode};
}
function renderFP(hist, currentFAS){
  const recent=hist.slice(-5);
  const avg=recent.length? recent.map(x=>x.FAS).reduce((a,b)=>a+b,0)/recent.length : 0.5;
  const past=colorForFAS(avg), now=colorForFAS(currentFAS);
  const delta=recent.length? (currentFAS - recent[recent.length-1].FAS) : 0;
  const futureGuess=Math.max(0, Math.min(1, currentFAS + 0.3*delta));
  const future=colorForFAS(futureGuess);
  document.getElementById('colorPast').style.background=past.hex;
  document.getElementById('colorNow').style.background=now.hex;
  document.getElementById('colorFuture').style.background=future.hex;
  document.getElementById('colorPast').title='昔の色: '+past.jp;
  document.getElementById('colorNow').title='今の色: '+now.jp;
  document.getElementById('colorFuture').title='未来の色: '+future.jp;
  setStatus('fpStatus','ready',true);
}
function resetOutputs(full=false){
  document.getElementById('fasVal').textContent='—'; badge('low'); document.getElementById('sumOut').textContent='(入力が空です)'; document.getElementById('jsonOut').textContent='{}';
  ['colorPast','colorNow','colorFuture'].forEach(id=>{ const el=document.getElementById(id); el.style.background='transparent'; el.title=''; });
  if(full) History.clear();
}
async function boot(){
  DICT = await loadJSON('dictionary_5x_mega.json','dictStatus');
  document.getElementById('calcBtn').onclick=onCalc;
  document.getElementById('demoBtn').onclick=()=>{ document.getElementById('txt').value='昨夜は眠れず不安が強かったけれど、朝に散歩と深呼吸をして少し落ち着きました。今日は友人に短く連絡して、できることを一つだけ試してみます。'; onCalc(); };
  document.getElementById('clearBtn').onclick=()=>{ document.getElementById('txt').value=''; resetOutputs(true); };
}
function onCalc(){
  const text=document.getElementById('txt').value.trim();
  if(!text){ resetOutputs(); return; }
  const r=compute(text);
  renderFP(History.read(), r.FAS);
  document.getElementById('fasVal').textContent=r.FAS.toFixed(3); badge(labelByFAS(r.FAS, MODE.thresholds));
  document.getElementById('sumOut').textContent=summarize(r);
  const out={schema_version:'5.0-deepsea',FAS_composite:+r.FAS.toFixed(3),CUS:+r.CUS.toFixed(3),RIS:+r.RIS.toFixed(3),EIS:+r.EIS.toFixed(3),SSS:+r.SSS.toFixed(3),FlameState:{mode:r.mode,FAS_zone:labelByFAS(r.FAS,MODE.thresholds),CUS_zone:(r.CUS>=.66?'High':(r.CUS>=.33?'Moderate':'Low')),confidence:0.8}};
  document.getElementById('jsonOut').textContent=JSON.stringify(out,null,2);
  History.push({FAS:r.FAS, mode:r.mode});
}
document.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
